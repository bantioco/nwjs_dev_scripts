<div id="add_data_bloc">
    <h1>Add data</h1>
    <div>
        <form id="add_data">
            <div class="bloc-input"><input type="text" id="add_data_title" placeholder="title"></div>
            <div class="bloc-input load-category"></div>
            <div class="bloc-input">
                <textarea id="add_data_text" cols="30" rows="10"></textarea>
            </div>
            <div class="bloc-input"><button type="submit">save</button></div>
        </form>
    </div>
</div>
<script>
    (function( $ ){
        $(document).ready(function(){

            $.post('./load/load_category_select.html', function( datacategory ){
                $('.load-category').html( datacategory );
            });

            tinymce.remove('textarea')
            tinymce.init({
                selector: '#add_data_text',
                height: 350,
                theme: 'modern',
                menubar: false,
                plugins: [
                    'advlist autolink lists link image charmap print preview hr anchor pagebreak',
                    'searchreplace wordcount visualblocks visualchars code fullscreen',
                    'insertdatetime media nonbreaking save table contextmenu directionality',
                    'emoticons template paste textcolor colorpicker textpattern imagetools codesample toc'
                ],
                toolbar1: 'undo redo | bold italic | alignleft aligncenter alignright alignjustify | link | preview | forecolor backcolor emoticons | codesample',
                toolbar2: '',
                image_advtab: true,
                templates: [
                    { title: 'Test template 1', content: 'Test 1' },
                    { title: 'Test template 2', content: 'Test 2' }
                ]
            });

            var fs = require('fs');

            setTimeout(function(){

                $('form#add_data').on('submit', function( e ){
                    e.preventDefault();
                    //var form_post = new FormData( $(this)[0] );

                    // Get data form
                    let data_title      = $('#add_data_title').val();
                    let data_category   = $('#add_data_category').val();
                    let data_text       = $('#add_data_text').val();

                    // Controle lenght post data_title
                    if( data_title.length >= 1 ){
                        // Controle lenght post data_category
                        if( data_category.length >= 1 ){
                            // Controle lenght post data_text
                            if( data_text.length >= 1){
                                fs.open('data/data_scripts.json', 'r+', (err, fd) => {
                                    if( err || fd == undefined ){ create_file( data_title, data_category, data_text ); }
                                    else{ add_data_in_file( data_title, data_category, data_text ); }
                                });
                            }
                            // Notice lenght post data_text
                            else{
                                $('#add_data_text').val('required');
                                setTimeout(function(){ $('#add_data_text').val(''); },1000);
                            }
                        }
                        else{}
                    }
                    // Notice lenght post data_title
                    else{
                        $('#add_data_title').val('required');
                        setTimeout(function(){ $('#add_data_title').val(''); },1000);
                    }

                });

                // Create file & add data
                function create_file( title, category, text ){
                    var json_data = { data: [ { title:title, category:category, text:text } ] };
                    fs.writeFile('data/data_scripts.json', JSON.stringify( json_data ), (err) => {
                      if (err) throw err;
                      console.log('It\'s saved!');
                      $.post('./load/load_data_list.html', function( datalist ){ $('.js-load-data-list').html( datalist ); });
                    });
                }

                // Add data in file
                function add_data_in_file( title, category, text ){
                    $.getJSON( 'data/data_scripts.json',function(getdata){
                        getdata.data.push( { title:title, category:category, text:text } );
                        fs.writeFile('data/data_scripts.json', JSON.stringify( getdata ), (err) => {
                          if (err) throw err;
                          console.log('It\'s saved!');
                          $.post('./load/load_data_list.html', function( datalist ){ $('.js-load-data-list').html( datalist ); });
                        });
                    });
                }

            },200);
        });
    })( jQuery );
</script>
